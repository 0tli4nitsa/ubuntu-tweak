#!/bin/bash

MPLAYER_DIR=`echo ~/.mplayer`

if [ ! -d $MPLAYER_DIR ]; then
	mkdir ~/.mplayer
fi

#MPLAYER Settings
MPLAYER_GUI_CONF=`echo ~/.mplayer/gui.conf`
MPLAYER_CONFIG=`echo ~/.mplayer/config`

VO_DRIVER=`grep "vo_driver" $MPLAYER_GUI_CONF 2>/dev/null`
VO_DRIVER_VALUE=`grep "vo_driver" $MPLAYER_GUI_CONF 2>/dev/null | awk -F"\"" '{print $2}' `
ZOOM=`grep "zoom" $MPLAYER_CONFIG 2>/dev/null`
ZOOM_VALUE=`grep "zoom" $MPLAYER_CONFIG 2>/dev/null | sed -n '/[ytru]/p'`
SUB_FUZZINESS=`grep  "sub-fuzziness" $MPLAYER_CONFIG 2>/dev/null`
SUB_FUZZINESS_VALUE=`grep  "sub-fuzziness" $MPLAYER_CONFIG 2>/dev/null | sed -n '/1/p'`

#FCITX Settings
INPUT_METHOD=`env | grep XMODIFIERS | awk -F"=" '{print $3}'`
FCITX_SHARE=`whereis fcitx | awk '{print $5}'`
FCITX_TABLE=${FCITX_SHARE}/data/tables.conf
FCITX_USER_TABLE=`echo ~/.fcitx/tables.conf`
FCITX_USER_TABLE_TEMP=${FCITX_USER_TABLE}.tmp
FCITX_CONFIG=`echo ~/.fcitx/config`
FCITX_CONFIG_TEMP=${FCITX_CONFIG}.tmp

#初始化Mplayer vo_driver的设置
init_vo_driver(){
	if [ ! -f $MPLAYER_GUI_CONF ]; then
		echo "vo_driver = \"xv\"" > $MPLAYER_GUI_CONF
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/vo_driver false
		echo -e "配置文件不存在！建立$MPLAYER_GUI_CONF...\n设定VO_DRIVER为FALSE..."
	else
		if [ ! -z "$VO_DRIVER" ]; then
			if [ "$VO_DRIVER_VALUE" = "x11" ]; then
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/vo_driver true
				echo "Setting VO_DRIVER->TRUE..."
			else
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/vo_driver false
				echo "Setting VO_DRIVER->FALSE..."
			fi
		else
			echo "vo_driver = \"xv\"" >> $MPLAYER_GUI_CONF
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/vo_driver false
			echo "相关字段不存在！初始化...设定VO_DRIVER为FALSE"
		fi
	fi
}
#初始化Mplayer zoom的设置
init_zoom(){
	if [ ! -f $MPLAYER_CONFIG ]; then
		echo "zoom = \"no\"" > $MPLAYER_CONFIG
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/zoom false
		echo -e "配置文件不存在！建立$MPLAYER_CONFIG...\n设定ZOOM为FALSE..."
	else
		if [ ! -z "$ZOOM" ]; then
			if [ ! -z "$ZOOM_VALUE"  ]; then
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/zoom true
				echo "Setting ZOOM->TRUE..."
			else
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/zoom false
				echo "Setting ZOOM->FALSE..."
			fi
		else
			echo "zoom = \"no\"" >> $MPLAYER_CONFIG
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/zoom false
			echo "相关字段不存在！初始化...设定ZOOM为FALSE"
		fi
	fi
}

#初始化Mplayer sub-fuzziness的设置
init_sub_fuzziness(){
	if [ ! -f $MPLAYER_CONFIG ]; then
		echo "sub-fuzziness = 0" > $MPLAYER_CONFIG
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/sub-fuzziness false
		echo -e "配置文件不存在！建立$MPLAYER_CONFIG...\n设定SUB_FUZZINESS为FALSE..."
	else
		if [ ! -z "$SUB_FUZZINESS" ]; then
			if [ ! -z "$SUB_FUZZINESS_VALUE"  ]; then
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/sub-fuzziness true
				echo "Setting SUB_FUZZINESS->TRUE..."
			else
				gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/sub-fuzziness false
				echo "Setting SUB_FUZZINESS->FALSE..."
			fi
		else
			echo "sub-fuzziness = 0" >> $MPLAYER_CONFIG
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/sub-fuzziness false
			echo "相关字段不存在！初始化...设定SUB_FUZZINESS为FALSE"
		fi
	fi
}

echo "=====================Initializing================"

if [ -f /usr/bin/mplayer ]; then
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/installed true
		init_vo_driver
		init_zoom
		init_sub_fuzziness
	else
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/mplayer/installed false
		echo "注意：mplayer未安装"
fi

if [ -f /usr/bin/avant-window-navigator ]; then
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/awn/installed true
	else
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/apps/awn/installed false
		echo "注意：Avant Window Navigator未安装"
fi

if [ $INPUT_METHOD = "fcitx" ]; then
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/system/fcitx true
		if [ ! -f $FCITX_USER_TABLE ]; then
			cp -v $FCITX_TABLE $FCITX_USER_TABLE
		fi
		iconv -f GB2312 -t UTF-8 $FCITX_USER_TABLE | sed '$!N; /^\(.*\)\n\1$/!P; D' >$FCITX_USER_TABLE_TEMP
		iconv -f GB2312 -t UTF-8 $FCITX_CONFIG>$FCITX_CONFIG_TEMP
		TABLE_WBX=`grep wbx.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_WBX" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wbx false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wbx true
		fi	
		TABLE_WBPY=`grep wbpy.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_WBPY" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wbpy false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wbpy true
		fi	
		TABLE_ERBI=`grep erbi.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_ERBI" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/erbi false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/erbi true
		fi	
		TABLE_CJ=`grep cj.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_CJ" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/cj false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/cj true
		fi	
		TABLE_WF=`grep wanfeng.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_WF" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wf false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/wf true
		fi	
		TABLE_QXM=`grep qxm.mb $FCITX_USER_TABLE_TEMP`
		if [ -z "$TABLE_QXM" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/qxm false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/qxm true
		fi	
		TABLE_PY=`grep 使用拼音 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$TABLE_PY" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/py false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/py true
		fi	
		TABLE_SP=`grep 使用双拼 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$TABLE_SP" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/sp false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/sp true
		fi	
		TABLE_QW=`grep 使用区位 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$TABLE_QW" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/qw false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/qw true
		fi
		TABLE_BANNER_MODE=`grep 主窗口隐藏模式 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$TABLE_BANNER_MODE" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/banner_mode false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/banner_mode true
		fi
		SHOW_TYPE_SPEED=`grep 显示打字速度 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$SHOW_TYPE_SPEED" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/show_type_speed false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/show_type_speed true
		fi
		SHOW_VERSION=`grep 显示版本 $FCITX_CONFIG_TEMP|awk -F"=" '{print $2}'|grep 1`
		if [ -z "$SHOW_VERSION" ]; then 
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/show_version false
		else
			gconftool-2 --set --type boolean /apps/ubuntu-tweak/user/fcitx/show_version true
		fi
		iconv -f UTF-8 -t GB2312 $FCITX_USER_TABLE_TEMP>$FCITX_USER_TABLE
		iconv -f UTF-8 -t GB2312 $FCITX_CONFIG_TEMP>$FCITX_CONFIG
		rm $FCITX_CONFIG_TEMP $FCITX_USER_TABLE_TEMP
	else	
		gconftool-2 --set --type boolean /apps/ubuntu-tweak/system/fcitx false
fi

echo "=====================Finished================"
